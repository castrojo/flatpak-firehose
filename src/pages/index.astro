---
import BaseLayout from '../layouts/BaseLayout.astro';
import GroupedReleaseCard from '../components/GroupedReleaseCard.astro';
import FeaturedAppBanner from '../components/FeaturedAppBanner.astro';
import FilterBar from '../components/FilterBar.astro';

// Import apps from JSON (generated by Go pipeline)
import appsData from '../data/apps.json';

const baseUrl = import.meta.env.BASE_URL;

// Define types for better type safety
interface App {
  id: string;
  name: string;
  summary: string;
  developerName?: string;
  icon?: string;
  projectLicense?: string;
  categories?: string[];
  currentReleaseVersion?: string;
  currentReleaseDate?: string;
  flathubUrl?: string;
  installsLastMonth?: number;
  favoritesCount?: number;
  isVerified?: boolean;
  packageType: string;
  sourceRepo?: {
    type: string;
    url: string;
    owner?: string;
    repo?: string;
  };
  homebrewInfo?: {
    formula: string;
    homepage?: string;
  };
  releases?: Array<{
    version: string;
    date: string;
    title: string;
    description?: string;
    url?: string;
    type: string;
  }>;
}

interface ReleaseWithApp {
  version: string;
  date: string;
  title: string;
  description?: string;
  url?: string;
  type: string;
  app: {
    id: string;
    name: string;
    icon?: string;
    packageType: string;
    summary: string;
    flathubUrl?: string;
    sourceRepo?: {
      type: string;
      url: string;
      owner?: string;
      repo?: string;
    };
    homebrewInfo?: {
      formula: string;
      homepage?: string;
    };
  };
}

// Extract apps from the JSON structure
const apps = (appsData.apps as App[]) || [];
const metadata = appsData.metadata;

// Extract all releases and attach app info
const allReleases: ReleaseWithApp[] = [];
apps.forEach(app => {
  if (app.releases && app.releases.length > 0) {
    app.releases.forEach(release => {
      allReleases.push({
        ...release,
        app: {
          id: app.id,
          name: app.name,
          icon: app.icon,
          packageType: app.packageType,
          summary: app.summary,
          flathubUrl: app.flathubUrl,
          sourceRepo: app.sourceRepo,
          homebrewInfo: app.homebrewInfo,
        }
      });
    });
  }
});

// Sort releases by date (newest first)
allReleases.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Group releases by app (project)
interface AppGroup {
  appId: string;
  appName: string;
  mainRelease: ReleaseWithApp;
  olderReleases: ReleaseWithApp[];
}

const releasesByApp = new Map<string, AppGroup>();
allReleases.forEach(release => {
  const appKey = release.app.id;
  
  if (!releasesByApp.has(appKey)) {
    releasesByApp.set(appKey, {
      appId: release.app.id,
      appName: release.app.name,
      mainRelease: release,
      olderReleases: []
    });
  } else {
    releasesByApp.get(appKey)!.olderReleases.push(release);
  }
});

// Convert to array and sort by main release date (newest first)
const groupedReleases = Array.from(releasesByApp.values())
  .sort((a, b) => new Date(b.mainRelease.date).getTime() - new Date(a.mainRelease.date).getTime());

// Count statistics
const appsWithGitHub = apps.filter(app => app.sourceRepo && app.sourceRepo.type === 'github').length;
const appsWithChangelogs = apps.filter(app => app.releases && app.releases.length > 0).length;
const appsVerified = apps.filter(app => app.isVerified).length;

// Count package types
const flatpakApps = apps.filter((app: any) => app.packageType === 'flatpak').length;
const homebrewApps = apps.filter((app: any) => app.packageType === 'homebrew').length;
const osReleases = apps.filter((app: any) => app.packageType === 'os').length;

// Calculate total installs and favorites
const totalInstalls = apps.reduce((sum, app) => sum + (app.installsLastMonth || 0), 0);
const totalFavorites = apps.reduce((sum, app) => sum + (app.favoritesCount || 0), 0);

// Extract unique categories for filter
const allCategories = new Set<string>();
apps.forEach(app => {
  app.categories?.forEach(cat => allCategories.add(cat));
});
const categories = Array.from(allCategories);

// Extract unique app names for search
const appNames = apps.map(app => app.name).sort();
---

<BaseLayout 
  title="Bluefin Firehose"
  description="Track updates for Bluefin OS, Flathub applications, and Homebrew packages"
  appNames={appNames}
  metadata={metadata}
  totalApps={apps.length}
>
  <div class="page-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- About box -->
      <div class="info-box">
        <h3>About</h3>
        <p>The Bluefin Firehose aggregates release notes and updates from Bluefin OS, Flathub applications, and Homebrew packages.</p>
        <div class="info-links">
          <a href="https://projectbluefin.io" target="_blank" rel="noopener" class="info-link">Project Bluefin</a>
          <a href="https://github.com/castrojo/bluefin-releases" target="_blank" rel="noopener" class="info-link">GitHub Repository</a>
          <a href={`${baseUrl}rss.xml`} class="info-link" title="Subscribe to all releases">游니 RSS Feed (All)</a>
          <a href={`${baseUrl}rss/flatpak.xml`} class="info-link" title="Flathub releases only">游니 RSS Feed (Flathub)</a>
          <a href={`${baseUrl}rss/homebrew.xml`} class="info-link" title="Homebrew releases only">游니 RSS Feed (Homebrew)</a>
          <a href={`${baseUrl}rss/os.xml`} class="info-link" title="OS releases only">游니 RSS Feed (OS)</a>
          <a href={`${baseUrl}rss/verified.xml`} class="info-link" title="Verified apps only">游니 RSS Feed (Verified)</a>
        </div>
      </div>

      <!-- Featured App Banner -->
      <FeaturedAppBanner apps={apps} />

      <!-- Filters -->
      <FilterBar categories={categories} />

      <!-- Stats box -->
      <div class="sidebar-section">
        <h2 class="sidebar-heading">Statistics</h2>
        <div class="stats-grid">
          <div class="stat">
            <div class="stat-value">{apps.length}</div>
            <div class="stat-label">Total Packages</div>
          </div>
          <div class="stat">
            <div class="stat-value">{osReleases}</div>
            <div class="stat-label">OS Releases</div>
          </div>
          <div class="stat">
            <div class="stat-value">{flatpakApps}</div>
            <div class="stat-label">Flathub Apps</div>
          </div>
          <div class="stat">
            <div class="stat-value">{homebrewApps}</div>
            <div class="stat-label">Homebrew Packages</div>
          </div>
          <div class="stat">
            <div class="stat-value">{appsVerified}</div>
            <div class="stat-label">Verified</div>
          </div>
          <div class="stat">
            <div class="stat-value">{appsWithGitHub}</div>
            <div class="stat-label">GitHub Repos</div>
          </div>
          <div class="stat">
            <div class="stat-value">{appsWithChangelogs}</div>
            <div class="stat-label">With Changelogs</div>
          </div>
          <div class="stat">
            <div class="stat-value">{totalInstalls.toLocaleString()}</div>
            <div class="stat-label">Total Installs (30d)</div>
          </div>
        </div>
      </div>

      <!-- Made with love box -->
      <div class="sidebar-section made-with-love">
        <p>Made with <strong>&lt;3</strong> by the Bluefin Community</p>
      </div>
    </aside>

    <!-- Main content area -->
    <div class="main-content">
      <div class="releases-timeline">
        <h2 class="timeline-header">Recent Releases</h2>
        <div class="releases-list">
          {groupedReleases.map((group) => (
            <GroupedReleaseCard 
              mainRelease={group.mainRelease} 
              olderReleases={group.olderReleases} 
            />
          ))}
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Page-specific layout styles */

    .page-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 2rem;
      align-items: start;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-section {
      background: var(--color-bg-default);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 1.5rem;
    }

    .sidebar-heading {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--color-border-default);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .stat {
      padding: 0.75rem;
      text-align: center;
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      background: var(--color-bg-secondary);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      color: var(--color-accent-emphasis);
      line-height: 1;
    }

    .stat-label {
      color: var(--color-text-secondary);
      font-size: 0.75rem;
      margin-top: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .info-box {
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 1rem;
    }

    .info-box h3 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text-primary);
    }

    .info-box p {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.75rem;
    }

    .info-links {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .info-link {
      display: block;
      color: var(--color-text-link);
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.2s ease;
    }

    .info-link:hover {
      color: var(--color-accent-emphasis);
      text-decoration: underline;
    }

    .main-content {
      min-width: 0;
    }

    .releases-timeline {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 3rem;
      max-width: 100%;
    }

    .timeline-header {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--color-border-default);
    }

    .releases-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .made-with-love {
      text-align: center;
    }

    .made-with-love p {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin: 0;
    }

    /* Responsive design */
    @media (max-width: 1023px) {
      .page-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .site-title {
        font-size: 1.5rem;
      }

      .apps-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
