---
import AppCard from '../components/AppCard.astro';
import FilterBar from '../components/FilterBar.astro';
import KeyboardHelp from '../components/KeyboardHelp.astro';
import SearchBar from '../components/SearchBar.astro';
import ThemeToggle from '../components/ThemeToggle.astro';

// Import apps from JSON (generated by Go pipeline)
import appsData from '../data/apps.json';

const baseUrl = import.meta.env.BASE_URL;

// Define types for better type safety
interface App {
  id: string;
  name: string;
  summary: string;
  developerName?: string;
  icon?: string;
  projectLicense?: string;
  categories?: string[];
  currentReleaseVersion?: string;
  currentReleaseDate?: string;
  flathubUrl: string;
  installsLastMonth?: number;
  favoritesCount?: number;
  isVerified?: boolean;
  sourceRepo?: {
    type: string;
    url: string;
    owner?: string;
    repo?: string;
  };
  releases?: Array<{
    version: string;
    date: string;
    title: string;
    description?: string;
    url?: string;
    type: string;
  }>;
}

// Extract apps from the JSON structure
const apps = (appsData.apps as App[]) || [];
const metadata = appsData.metadata;

// Count statistics
const appsWithGitHub = apps.filter(app => app.sourceRepo && app.sourceRepo.type === 'github').length;
const appsWithChangelogs = apps.filter(app => app.releases && app.releases.length > 0).length;
const appsVerified = apps.filter(app => app.isVerified).length;

// Calculate total installs and favorites
const totalInstalls = apps.reduce((sum, app) => sum + (app.installsLastMonth || 0), 0);
const totalFavorites = apps.reduce((sum, app) => sum + (app.favoritesCount || 0), 0);

// Extract unique categories for filter
const allCategories = new Set<string>();
apps.forEach(app => {
  app.categories?.forEach(cat => allCategories.add(cat));
});
const categories = Array.from(allCategories);

// Extract unique app names for search
const appNames = apps.map(app => app.name).sort();
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bluefin Firehose</title>
  <meta name="description" content="Track updates for Bluefin OS, Flatpak applications, and Homebrew packages">
  
  <!-- Theme initialization script - runs before page render to prevent FOUC -->
  <script is:inline>
    (function() {
      const getTheme = () => {
        // Check localStorage first
        const stored = localStorage.getItem('theme');
        if (stored === 'light' || stored === 'dark') {
          return stored;
        }
        // Fall back to system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      };
      
      const theme = getTheme();
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  
  <style>
    :root {
      /* Bluefin color palette - Light Mode (Default) */
      --color-bg-default: #ffffff;
      --color-bg-secondary: #fdfdfd;
      --color-bg-tertiary: #f9fafb;
      --color-border-default: #e5e7eb;
      --color-text-primary: #1f2937;
      --color-text-secondary: #6b7280;
      --color-text-tertiary: #9ca3af;
      --color-text-link: #6c7ae9;
      --color-accent-emphasis: #6c7ae9;
      --color-success: #3fb950;
    }

    /* Dark Mode Theme */
    [data-theme="dark"] {
      --color-bg-default: #0d1117;
      --color-bg-secondary: #010409;
      --color-bg-tertiary: #161b22;
      --color-border-default: #30363d;
      --color-text-primary: #c9d1d9;
      --color-text-secondary: #8b949e;
      --color-text-tertiary: #6e7681;
      --color-text-link: #93a8ff;
      --color-accent-emphasis: #93a8ff;
      --color-success: #3fb950;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      color: var(--color-text-primary);
      background: var(--color-bg-secondary);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .site-header {
      background: var(--color-bg-default);
      border-bottom: 1px solid var(--color-border-default);
      padding: 2rem 0;
      margin-bottom: 2rem;
    }

    .site-title {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--color-text-primary);
    }

    .home-link {
      color: var(--color-text-primary);
      text-decoration: none;
      transition: opacity 0.2s ease;
    }

    .home-link:hover {
      opacity: 0.8;
    }

    .site-subtitle {
      color: var(--color-text-secondary);
      font-size: 1rem;
    }

    .page-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 2rem;
      align-items: start;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-section {
      background: var(--color-bg-default);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 1.5rem;
    }

    .sidebar-heading {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--color-border-default);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .stat {
      padding: 0.75rem;
      text-align: center;
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      background: var(--color-bg-secondary);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      color: var(--color-accent-emphasis);
      line-height: 1;
    }

    .stat-label {
      color: var(--color-text-secondary);
      font-size: 0.75rem;
      margin-top: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .info-box {
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 1rem;
    }

    .info-box h3 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text-primary);
    }

    .info-box p {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.75rem;
    }

    .info-links {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .info-link {
      display: block;
      color: var(--color-text-link);
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.2s ease;
    }

    .info-link:hover {
      color: var(--color-accent-emphasis);
      text-decoration: underline;
    }

    .main-content {
      min-width: 0;
    }

    .apps-grid {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 3rem;
      max-width: 100%;
    }

    .site-footer {
      background: var(--color-bg-default);
      border-top: 1px solid var(--color-border-default);
      padding: 2rem 0;
      margin-top: 3rem;
      text-align: center;
      color: var(--color-text-secondary);
      font-size: 0.875rem;
    }

    .site-footer p {
      margin-bottom: 0.5rem;
    }

    .site-footer a {
      color: var(--color-text-link);
      text-decoration: none;
    }

    .site-footer a:hover {
      text-decoration: underline;
    }

    .made-with-love {
      text-align: center;
    }

    .made-with-love p {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin: 0;
    }

    /* Keyboard navigation focus styles */
    :global(.app-card.kbd-focused) {
      box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
      border-color: #0969da;
    }

    /* Screen reader only utility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Help button in header */
    .keyboard-help-button {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      font-size: 1rem;
      font-weight: 600;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .keyboard-help-button:hover {
      background: var(--color-bg-default);
      color: var(--color-text-primary);
      border-color: var(--color-text-primary);
    }

    /* Responsive design */
    @media (max-width: 1023px) {
      .page-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .site-title {
        font-size: 1.5rem;
      }

      .apps-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 2rem;">
        <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
          <div>
            <h1 class="site-title">
              <a href={baseUrl} id="home-link" class="home-link">
                <img src="/bluefin-logo.svg" alt="Bluefin logo" style="width: 32px; height: 32px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" />
                Bluefin Firehose
              </a>
            </h1>
            <p class="site-subtitle">Track updates for Bluefin OS, Flatpak apps, and Homebrew packages</p>
          </div>
          <div style="flex: 1; max-width: 600px;">
            <SearchBar apps={appNames} />
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <ThemeToggle />
          <button 
            id="help-button" 
            class="keyboard-help-button"
            aria-label="Keyboard shortcuts"
            title="Keyboard shortcuts (Press ?)"
          >
            ?
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- About box -->
        <div class="info-box">
          <h3>About</h3>
          <p>The Bluefin Firehose aggregates release notes and updates from Bluefin OS, Flatpak applications, and Homebrew packages.</p>
          <div class="info-links">
            <a href="https://projectbluefin.io" target="_blank" rel="noopener" class="info-link">Project Bluefin</a>
            <a href="https://github.com/castrojo/bluefin-releases" target="_blank" rel="noopener" class="info-link">GitHub Repository</a>
          </div>
        </div>

        <!-- Filters -->
        <FilterBar categories={categories} />

        <!-- Stats box -->
        <div class="sidebar-section">
          <h2 class="sidebar-heading">Statistics</h2>
          <div class="stats-grid">
            <div class="stat">
              <div class="stat-value">{apps.length}</div>
              <div class="stat-label">Total Apps</div>
            </div>
            <div class="stat">
              <div class="stat-value">{appsVerified}</div>
              <div class="stat-label">Verified</div>
            </div>
            <div class="stat">
              <div class="stat-value">{appsWithGitHub}</div>
              <div class="stat-label">GitHub Repos</div>
            </div>
            <div class="stat">
              <div class="stat-value">{appsWithChangelogs}</div>
              <div class="stat-label">With Changelogs</div>
            </div>
            <div class="stat">
              <div class="stat-value">{totalInstalls.toLocaleString()}</div>
              <div class="stat-label">Total Installs (30d)</div>
            </div>
            <div class="stat">
              <div class="stat-value">{totalFavorites}</div>
              <div class="stat-label">Total Favorites</div>
            </div>
          </div>
        </div>

        <!-- Made with love box -->
        <div class="sidebar-section made-with-love">
          <p>Made with <strong>&lt;3</strong> by the Bluefin Community</p>
        </div>
      </aside>

      <!-- Main content area -->
      <div class="main-content">
        <div class="apps-grid">
          {apps.map((app: any) => (
            <AppCard app={app} />
          ))}
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>Aggregating {apps.length} apps from Flathub • {metadata.stats.totalReleases} releases tracked</p>
      <p>Updated daily • <a href="https://github.com/castrojo/bluefin-releases" target="_blank" rel="noopener">View on GitHub</a></p>
      <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 0.5rem;">
        Generated {metadata.generatedAt} by {metadata.generatedBy} in {metadata.buildDuration}
      </p>
    </div>
  </footer>

  <!-- Keyboard shortcuts help modal -->
  <KeyboardHelp />

  <!-- Screen reader live region for keyboard navigation announcements -->
  <div id="kbd-live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>

  <!-- Keyboard navigation script -->
  <script is:inline>
    // Keyboard navigation
    class KeyboardNavigator {
      focusedIndex = -1;
      /** @type {HTMLElement[]} */
      items = [];
      /** @type {HTMLElement | null} */
      searchInput = null;
      /** @type {string} */
      itemSelector = '';
      
      /**
       * @param {string} itemSelector
       * @param {string} searchInputSelector
       */
      constructor(itemSelector, searchInputSelector) {
        this.itemSelector = itemSelector;
        this.items = Array.from(document.querySelectorAll(itemSelector));
        this.searchInput = document.querySelector(searchInputSelector);
        this.attachListeners();
        console.log(`[KeyboardNav] Initialized with ${this.items.length} items`);
      }
      
      attachListeners() {
        document.addEventListener('keydown', (e) => {
          if (this.isTypingContext(e.target)) return;
          
          switch(e.key) {
            case 'j':
              e.preventDefault();
              this.moveDown();
              break;
            case 'k':
              e.preventDefault();
              this.moveUp();
              break;
            case '/':
              e.preventDefault();
              this.focusSearch();
              break;
            case 'o':
            case 'Enter':
              e.preventDefault();
              this.openFocused();
              break;
            case '?':
              e.preventDefault();
              this.showHelp();
              break;
            case 't':
              e.preventDefault();
              this.toggleTheme();
              break;
            case ' ':
              e.preventDefault();
              if (e.shiftKey) {
                window.scrollBy({ top: -window.innerHeight, behavior: 'smooth' });
              } else {
                window.scrollBy({ top: window.innerHeight, behavior: 'smooth' });
              }
              break;
            case 'h':
              e.preventDefault();
              window.scrollTo({ top: 0, behavior: 'smooth' });
              break;
            case 's':
              e.preventDefault();
              this.focusSearch();
              break;
            case 'Escape':
              this.handleEscape();
              break;
          }
        });
      }
      
      /**
       * @param {EventTarget | null} target
       * @returns {boolean}
       */
      isTypingContext(target) {
        if (!target || !(target instanceof HTMLElement)) return false;
        const tagName = target.tagName.toLowerCase();
        if (tagName === 'input' || tagName === 'textarea') return true;
        if (target.isContentEditable) return true;
        if (target.closest('.search-bar')) return true;
        return false;
      }
      
      moveDown() {
        if (this.items.length === 0) return;
        this.focusedIndex = Math.min(this.focusedIndex + 1, this.items.length - 1);
        this.scrollToFocused();
        this.announceNavigation();
      }
      
      moveUp() {
        if (this.items.length === 0) return;
        this.focusedIndex = Math.max(this.focusedIndex - 1, 0);
        this.scrollToFocused();
        this.announceNavigation();
      }
      
      scrollToFocused() {
        const item = this.items[this.focusedIndex];
        if (!item) return;
        this.items.forEach(el => el.classList.remove('kbd-focused'));
        item.classList.add('kbd-focused');
        item.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
      }
      
      openFocused() {
        const item = this.items[this.focusedIndex];
        if (!item) return;
        
        // Open the Flathub link for the focused app card
        const link = item.querySelector('a[href*="flathub.org"]');
        if (link) window.open(link.href, '_blank', 'noopener,noreferrer');
      }
      
      focusSearch() {
        if (this.searchInput) {
          this.searchInput.focus();
          this.searchInput.select();
        }
      }
      
      showHelp() {
        document.getElementById('keyboard-help-modal')?.classList.add('visible');
        document.getElementById('keyboard-help-backdrop')?.classList.add('visible');
      }
      
      toggleTheme() {
        if (typeof window.toggleTheme === 'function') {
          window.toggleTheme();
        }
      }
      
      hideHelp() {
        document.getElementById('keyboard-help-modal')?.classList.remove('visible');
        document.getElementById('keyboard-help-backdrop')?.classList.remove('visible');
      }
      
      handleEscape() {
        const helpModal = document.getElementById('keyboard-help-modal');
        if (helpModal?.classList.contains('visible')) {
          this.hideHelp();
          return;
        }
        if (document.activeElement === this.searchInput) {
          this.searchInput?.blur();
          return;
        }
        this.items.forEach(el => el.classList.remove('kbd-focused'));
        this.focusedIndex = -1;
      }
      
      announceNavigation() {
        const item = this.items[this.focusedIndex];
        const liveRegion = document.getElementById('kbd-live-region');
        if (liveRegion && item) {
          const title = item.querySelector('h2, h3')?.textContent?.trim() || 'App';
          liveRegion.textContent = `Focused: ${title}`;
        }
      }
      
      refresh() {
        this.items = Array.from(document.querySelectorAll(this.itemSelector));
        console.log(`[KeyboardNav] Refreshed, now tracking ${this.items.length} items`);
      }
    }

    let navigator = null;
    document.addEventListener('DOMContentLoaded', () => {
      navigator = new KeyboardNavigator('.app-card', '.search-bar input');
    });
  </script>

  <!-- Help button handler -->
  <script>
    document.getElementById('help-button')?.addEventListener('click', () => {
      document.getElementById('keyboard-help-modal')?.classList.add('visible');
      document.getElementById('keyboard-help-backdrop')?.classList.add('visible');
    });
  </script>

  <!-- Home link handler - scroll to top -->
  <script>
    document.getElementById('home-link')?.addEventListener('click', (e) => {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>
