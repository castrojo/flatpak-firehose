---
import { Image } from 'astro:assets';
import ReleaseCard from '../components/ReleaseCard.astro';
import FeaturedAppBanner from '../components/FeaturedAppBanner.astro';
import FilterBar from '../components/FilterBar.astro';
import KeyboardHelp from '../components/KeyboardHelp.astro';
import SearchBar from '../components/SearchBar.astro';
import ThemeToggle from '../components/ThemeToggle.astro';

// Import global styles
import '../styles/tokens.css';
import '../styles/global.css';

// Import apps from JSON (generated by Go pipeline)
import appsData from '../data/apps.json';

// Import local images
import angryDinosaur from '../assets/angry-dinosaur.webp';
import bluefinLogo from '../assets/bluefin-logo.svg';

const baseUrl = import.meta.env.BASE_URL;

// Define types for better type safety
interface App {
  id: string;
  name: string;
  summary: string;
  developerName?: string;
  icon?: string;
  projectLicense?: string;
  categories?: string[];
  currentReleaseVersion?: string;
  currentReleaseDate?: string;
  flathubUrl?: string;
  installsLastMonth?: number;
  favoritesCount?: number;
  isVerified?: boolean;
  packageType: string;
  sourceRepo?: {
    type: string;
    url: string;
    owner?: string;
    repo?: string;
  };
  homebrewInfo?: {
    formula: string;
    homepage?: string;
  };
  releases?: Array<{
    version: string;
    date: string;
    title: string;
    description?: string;
    url?: string;
    type: string;
  }>;
}

interface ReleaseWithApp {
  version: string;
  date: string;
  title: string;
  description?: string;
  url?: string;
  type: string;
  app: {
    id: string;
    name: string;
    icon?: string;
    packageType: string;
    summary: string;
    flathubUrl?: string;
    sourceRepo?: {
      type: string;
      url: string;
      owner?: string;
      repo?: string;
    };
    homebrewInfo?: {
      formula: string;
      homepage?: string;
    };
  };
}

// Extract apps from the JSON structure
const apps = (appsData.apps as App[]) || [];
const metadata = appsData.metadata;

// Extract all releases and attach app info
const allReleases: ReleaseWithApp[] = [];
apps.forEach(app => {
  if (app.releases && app.releases.length > 0) {
    app.releases.forEach(release => {
      allReleases.push({
        ...release,
        app: {
          id: app.id,
          name: app.name,
          icon: app.icon,
          packageType: app.packageType,
          summary: app.summary,
          flathubUrl: app.flathubUrl,
          sourceRepo: app.sourceRepo,
          homebrewInfo: app.homebrewInfo,
        }
      });
    });
  }
});

// Sort releases by date (newest first)
allReleases.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Group releases by date
interface DateGroup {
  date: string;
  displayDate: string;
  releases: ReleaseWithApp[];
}

const releasesByDate = new Map<string, DateGroup>();
allReleases.forEach(release => {
  const date = new Date(release.date);
  const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD
  const displayDate = date.toLocaleDateString('en-US', { 
    weekday: 'long',
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  if (!releasesByDate.has(dateKey)) {
    releasesByDate.set(dateKey, {
      date: dateKey,
      displayDate,
      releases: []
    });
  }
  releasesByDate.get(dateKey)!.releases.push(release);
});

// Convert to array and sort by date (newest first)
const groupedReleases = Array.from(releasesByDate.values())
  .sort((a, b) => b.date.localeCompare(a.date));

// Count statistics
const appsWithGitHub = apps.filter(app => app.sourceRepo && app.sourceRepo.type === 'github').length;
const appsWithChangelogs = apps.filter(app => app.releases && app.releases.length > 0).length;
const appsVerified = apps.filter(app => app.isVerified).length;

// Count package types
const flatpakApps = apps.filter((app: any) => app.packageType === 'flatpak').length;
const homebrewApps = apps.filter((app: any) => app.packageType === 'homebrew').length;
const osReleases = apps.filter((app: any) => app.packageType === 'os').length;

// Calculate total installs and favorites
const totalInstalls = apps.reduce((sum, app) => sum + (app.installsLastMonth || 0), 0);
const totalFavorites = apps.reduce((sum, app) => sum + (app.favoritesCount || 0), 0);

// Extract unique categories for filter
const allCategories = new Set<string>();
apps.forEach(app => {
  app.categories?.forEach(cat => allCategories.add(cat));
});
const categories = Array.from(allCategories);

// Extract unique app names for search
const appNames = apps.map(app => app.name).sort();
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bluefin Firehose</title>
  <meta name="description" content="Track updates for Bluefin OS, Flathub applications, and Homebrew packages">
  
  <!-- Open Graph meta tags -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ublue-os.github.io/bluefin-releases/">
  <meta property="og:title" content="Bluefin Firehose - Track Bluefin OS, Flathub & Homebrew Updates">
  <meta property="og:description" content="Real-time release dashboard aggregating updates from Bluefin OS, Flathub applications, and Homebrew packages. Stay current with your favorite tools.">
  <meta property="og:image" content="https://ublue-os.github.io/bluefin-releases/angry-dinosaur.webp">
  
  <!-- Twitter Card meta tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://ublue-os.github.io/bluefin-releases/">
  <meta name="twitter:title" content="Bluefin Firehose - Track Bluefin OS, Flathub & Homebrew Updates">
  <meta name="twitter:description" content="Real-time release dashboard aggregating updates from Bluefin OS, Flathub applications, and Homebrew packages. Stay current with your favorite tools.">
  <meta name="twitter:image" content="https://ublue-os.github.io/bluefin-releases/angry-dinosaur.webp">
  
  <!-- RSS Feed Discovery -->
  <link rel="alternate" type="application/rss+xml" title="Bluefin Firehose - All Releases" href={`${baseUrl}rss.xml`} />
  <link rel="alternate" type="application/rss+xml" title="Bluefin Firehose - Flatpak Releases" href={`${baseUrl}rss/flatpak.xml`} />
  <link rel="alternate" type="application/rss+xml" title="Bluefin Firehose - Homebrew Releases" href={`${baseUrl}rss/homebrew.xml`} />
  <link rel="alternate" type="application/rss+xml" title="Bluefin Firehose - OS Releases" href={`${baseUrl}rss/os.xml`} />
  <link rel="alternate" type="application/rss+xml" title="Bluefin Firehose - Verified Apps Only" href={`${baseUrl}rss/verified.xml`} />
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- Theme initialization script - runs before page render to prevent FOUC -->
  <script is:inline>
    (function() {
      const getTheme = () => {
        // Check localStorage first
        const stored = localStorage.getItem('theme');
        if (stored === 'light' || stored === 'dark') {
          return stored;
        }
        // Fall back to system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      };
      
      const theme = getTheme();
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  
  <style>
    /* Page-specific layout styles */

    .page-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 2rem;
      align-items: start;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-section {
      background: var(--color-bg-default);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 1.5rem;
    }

    .sidebar-heading {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--color-border-default);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .stat {
      padding: 0.75rem;
      text-align: center;
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      background: var(--color-bg-secondary);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      color: var(--color-accent-emphasis);
      line-height: 1;
    }

    .stat-label {
      color: var(--color-text-secondary);
      font-size: 0.75rem;
      margin-top: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .info-box {
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 1rem;
    }

    .info-box h3 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text-primary);
    }

    .info-box p {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.75rem;
    }

    .info-links {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .info-link {
      display: block;
      color: var(--color-text-link);
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.2s ease;
    }

    .info-link:hover {
      color: var(--color-accent-emphasis);
      text-decoration: underline;
    }

    .main-content {
      min-width: 0;
    }

    .releases-timeline {
      display: flex;
      flex-direction: column;
      gap: 2.5rem;
      margin-bottom: 3rem;
      max-width: 100%;
    }

    .date-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .date-header {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin: 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--color-border-default);
      position: sticky;
      top: 0;
      background: var(--color-bg-secondary);
      z-index: 10;
      backdrop-filter: blur(8px);
    }

    .releases-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .made-with-love {
      text-align: center;
    }

    .made-with-love p {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin: 0;
    }

    /* Help button in header */
    .keyboard-help-button {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      font-size: 1rem;
      font-weight: 600;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .keyboard-help-button:hover {
      background: var(--color-bg-default);
      color: var(--color-text-primary);
      border-color: var(--color-text-primary);
    }

    /* Responsive design */
    @media (max-width: 1023px) {
      .page-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .site-title {
        font-size: 1.5rem;
      }

      .apps-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 2rem;">
        <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
          <div>
            <h1 class="site-title">
              <a href={baseUrl} id="home-link" class="home-link">
                <Image src={angryDinosaur} alt="Bluefin angry dinosaur mascot" height={48} style="width: auto; display: inline-block; vertical-align: middle; margin-right: 0.5rem; object-fit: contain;" />
                Bluefin Firehose
              </a>
            </h1>
            <p class="site-subtitle">Track updates for Bluefin OS, Flathub apps, and Homebrew packages</p>
          </div>
          <div style="flex: 1; max-width: 600px;">
            <SearchBar apps={appNames} />
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <ThemeToggle />
          <button 
            id="help-button" 
            class="keyboard-help-button"
            aria-label="Keyboard shortcuts"
            title="Keyboard shortcuts (Press ?)"
          >
            ?
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- About box -->
        <div class="info-box">
          <h3>About</h3>
          <p>The Bluefin Firehose aggregates release notes and updates from Bluefin OS, Flathub applications, and Homebrew packages.</p>
          <div class="info-links">
            <a href="https://projectbluefin.io" target="_blank" rel="noopener" class="info-link">Project Bluefin</a>
            <a href="https://github.com/castrojo/bluefin-releases" target="_blank" rel="noopener" class="info-link">GitHub Repository</a>
            <a href={`${baseUrl}rss.xml`} class="info-link" title="Subscribe to all releases">ðŸ“¡ RSS Feed (All)</a>
            <a href={`${baseUrl}rss/flatpak.xml`} class="info-link" title="Flathub releases only">ðŸ“¡ RSS Feed (Flathub)</a>
            <a href={`${baseUrl}rss/homebrew.xml`} class="info-link" title="Homebrew releases only">ðŸ“¡ RSS Feed (Homebrew)</a>
            <a href={`${baseUrl}rss/os.xml`} class="info-link" title="OS releases only">ðŸ“¡ RSS Feed (OS)</a>
            <a href={`${baseUrl}rss/verified.xml`} class="info-link" title="Verified apps only">ðŸ“¡ RSS Feed (Verified)</a>
          </div>
        </div>

        <!-- Featured App Banner -->
        <FeaturedAppBanner apps={apps} />

        <!-- Filters -->
        <FilterBar categories={categories} />

        <!-- Stats box -->
        <div class="sidebar-section">
          <h2 class="sidebar-heading">Statistics</h2>
          <div class="stats-grid">
            <div class="stat">
              <div class="stat-value">{apps.length}</div>
              <div class="stat-label">Total Packages</div>
            </div>
            <div class="stat">
              <div class="stat-value">{osReleases}</div>
              <div class="stat-label">OS Releases</div>
            </div>
            <div class="stat">
              <div class="stat-value">{flatpakApps}</div>
              <div class="stat-label">Flathub Apps</div>
            </div>
            <div class="stat">
              <div class="stat-value">{homebrewApps}</div>
              <div class="stat-label">Homebrew Packages</div>
            </div>
            <div class="stat">
              <div class="stat-value">{appsVerified}</div>
              <div class="stat-label">Verified</div>
            </div>
            <div class="stat">
              <div class="stat-value">{appsWithGitHub}</div>
              <div class="stat-label">GitHub Repos</div>
            </div>
            <div class="stat">
              <div class="stat-value">{appsWithChangelogs}</div>
              <div class="stat-label">With Changelogs</div>
            </div>
            <div class="stat">
              <div class="stat-value">{totalInstalls.toLocaleString()}</div>
              <div class="stat-label">Total Installs (30d)</div>
            </div>
          </div>
        </div>

        <!-- Made with love box -->
        <div class="sidebar-section made-with-love">
          <p>Made with <strong>&lt;3</strong> by the Bluefin Community</p>
        </div>
      </aside>

      <!-- Main content area -->
      <div class="main-content">
        <div class="releases-timeline">
          {groupedReleases.map((dateGroup) => (
            <div class="date-group">
              <h2 class="date-header">{dateGroup.displayDate}</h2>
              <div class="releases-list">
                {dateGroup.releases.map((release) => (
                  <ReleaseCard release={release} />
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>Aggregating {apps.length} packages from Project Bluefin â€¢ {metadata.stats.totalReleases} releases tracked</p>
      <p>Updated daily â€¢ <a href="https://github.com/castrojo/bluefin-releases" target="_blank" rel="noopener">View on GitHub</a></p>
      <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 0.5rem;">
        Generated {metadata.generatedAt} by {metadata.generatedBy} in {metadata.buildDuration}
      </p>
    </div>
  </footer>

  <!-- Keyboard shortcuts help modal -->
  <KeyboardHelp />

  <!-- Screen reader live region for keyboard navigation announcements -->
  <div id="kbd-live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>

  <!-- Keyboard navigation script -->
  <script is:inline>
    // Keyboard navigation
    class KeyboardNavigator {
      focusedIndex = -1;
      /** @type {HTMLElement[]} */
      items = [];
      /** @type {HTMLElement | null} */
      searchInput = null;
      /** @type {string} */
      itemSelector = '';
      
      /**
       * @param {string} itemSelector
       * @param {string} searchInputSelector
       */
      constructor(itemSelector, searchInputSelector) {
        this.itemSelector = itemSelector;
        this.items = Array.from(document.querySelectorAll(itemSelector));
        this.searchInput = document.querySelector(searchInputSelector);
        this.attachListeners();
        console.log(`[KeyboardNav] Initialized with ${this.items.length} items`);
      }
      
      attachListeners() {
        document.addEventListener('keydown', (e) => {
          if (this.isTypingContext(e.target)) return;
          
          switch(e.key) {
            case 'j':
              e.preventDefault();
              this.moveDown();
              break;
            case 'k':
              e.preventDefault();
              this.moveUp();
              break;
            case '/':
              e.preventDefault();
              this.focusSearch();
              break;
            case 'o':
            case 'Enter':
              e.preventDefault();
              this.openFocused();
              break;
            case '?':
              e.preventDefault();
              this.showHelp();
              break;
            case 't':
              e.preventDefault();
              this.toggleTheme();
              break;
            case ' ':
              e.preventDefault();
              if (e.shiftKey) {
                window.scrollBy({ top: -window.innerHeight, behavior: 'smooth' });
              } else {
                window.scrollBy({ top: window.innerHeight, behavior: 'smooth' });
              }
              break;
            case 'h':
              e.preventDefault();
              window.scrollTo({ top: 0, behavior: 'smooth' });
              break;
            case 's':
              e.preventDefault();
              this.focusSearch();
              break;
            case 'Escape':
              this.handleEscape();
              break;
          }
        });
      }
      
      /**
       * @param {EventTarget | null} target
       * @returns {boolean}
       */
      isTypingContext(target) {
        if (!target || !(target instanceof HTMLElement)) return false;
        const tagName = target.tagName.toLowerCase();
        if (tagName === 'input' || tagName === 'textarea') return true;
        if (target.isContentEditable) return true;
        if (target.closest('.search-bar')) return true;
        return false;
      }
      
      moveDown() {
        if (this.items.length === 0) return;
        this.focusedIndex = Math.min(this.focusedIndex + 1, this.items.length - 1);
        this.scrollToFocused();
        this.announceNavigation();
      }
      
      moveUp() {
        if (this.items.length === 0) return;
        this.focusedIndex = Math.max(this.focusedIndex - 1, 0);
        this.scrollToFocused();
        this.announceNavigation();
      }
      
      scrollToFocused() {
        const item = this.items[this.focusedIndex];
        if (!item) return;
        this.items.forEach(el => el.classList.remove('kbd-focused'));
        item.classList.add('kbd-focused');
        
        // Calculate the position to scroll to (accounting for header height)
        const headerHeight = document.querySelector('.site-header')?.offsetHeight || 0;
        const itemTop = item.getBoundingClientRect().top + window.pageYOffset;
        const scrollTo = itemTop - headerHeight - 16; // 16px additional padding
        
        window.scrollTo({ 
          top: scrollTo, 
          behavior: 'smooth' 
        });
      }
      
      openFocused() {
        const item = this.items[this.focusedIndex];
        if (!item) return;
        
        // Open the package detail link for the focused app card
        const link = item.querySelector('a[href*="flathub.org"], a[href*="formulae.brew.sh"]');
        if (link) window.open(link.href, '_blank', 'noopener,noreferrer');
      }
      
      focusSearch() {
        if (this.searchInput) {
          this.searchInput.focus();
          this.searchInput.select();
        }
      }
      
      showHelp() {
        document.getElementById('keyboard-help-modal')?.classList.add('visible');
        document.getElementById('keyboard-help-backdrop')?.classList.add('visible');
      }
      
      toggleTheme() {
        if (typeof window.toggleTheme === 'function') {
          window.toggleTheme();
        }
      }
      
      hideHelp() {
        document.getElementById('keyboard-help-modal')?.classList.remove('visible');
        document.getElementById('keyboard-help-backdrop')?.classList.remove('visible');
      }
      
      handleEscape() {
        const helpModal = document.getElementById('keyboard-help-modal');
        if (helpModal?.classList.contains('visible')) {
          this.hideHelp();
          return;
        }
        if (document.activeElement === this.searchInput) {
          this.searchInput?.blur();
          return;
        }
        this.items.forEach(el => el.classList.remove('kbd-focused'));
        this.focusedIndex = -1;
      }
      
      announceNavigation() {
        const item = this.items[this.focusedIndex];
        const liveRegion = document.getElementById('kbd-live-region');
        if (liveRegion && item) {
          const title = item.querySelector('h2, h3')?.textContent?.trim() || 'App';
          liveRegion.textContent = `Focused: ${title}`;
        }
      }
      
      refresh() {
        this.items = Array.from(document.querySelectorAll(this.itemSelector));
        console.log(`[KeyboardNav] Refreshed, now tracking ${this.items.length} items`);
      }
    }

    let navigator = null;
    document.addEventListener('DOMContentLoaded', () => {
      navigator = new KeyboardNavigator('.release-card', '.search-bar input');
    });
  </script>

  <!-- Help button handler -->
  <script>
    document.getElementById('help-button')?.addEventListener('click', () => {
      document.getElementById('keyboard-help-modal')?.classList.add('visible');
      document.getElementById('keyboard-help-backdrop')?.classList.add('visible');
    });
  </script>

  <!-- Home link handler - scroll to top -->
  <script>
    document.getElementById('home-link')?.addEventListener('click', (e) => {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>
