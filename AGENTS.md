# Agent Instructions

This project uses **bd** (beads) for issue tracking. Run `bd onboard` to get started.

## Project Overview

**Bluefin Firehose** is a unified release dashboard that aggregates updates from three sources:
- **Bluefin OS releases** (from ublue-os/bluefin repository)
- **Flatpak applications** (42 curated apps from Bluefin's system Brewfiles)
- **Homebrew packages** (44 packages from Bluefin's CLI, AI, K8s, and IDE tool collections)

The project uses a **hybrid architecture**: Go backend for data aggregation + Astro frontend for static site generation.

## Quick Reference

```bash
bd ready              # Find available work
bd show <id>          # View issue details
bd update <id> --status in_progress  # Claim work
bd close <id>         # Complete work
bd sync               # Sync with git
```

## Architecture

### Data Pipeline (Go)

**Entry Point:** `cmd/bluefin-releases/main.go`

The pipeline runs in three parallel phases:

1. **Flatpak Fetcher** (`internal/bluefin/flatpaks.go`)
   - Reads curated app lists from Bluefin Brewfiles (system-flatpaks.Brewfile, system-dx-flatpaks.Brewfile)
   - Fetches metadata from Flathub API via `internal/flathub/flathub.go`
   - Enriches with GitHub repo detection
   - ~42 apps total

2. **Homebrew Fetcher** (`internal/bluefin/homebrew.go`)
   - Reads package lists from Bluefin Brewfiles (cli.Brewfile, ai-tools.Brewfile, k8s-tools.Brewfile, ide.Brewfile)
   - Fetches metadata from Homebrew formulae API
   - Filters for Linux-compatible packages
   - Extracts GitHub repos for release tracking
   - ~44 packages total

3. **OS Releases Fetcher** (`internal/bluefin/releases.go`)
   - Fetches latest releases from ublue-os/bluefin GitHub repository
   - Parses release notes for version info and changelogs
   - ~10 releases total

4. **GitHub Enrichment** (`internal/github/github.go`)
   - Fetches actual release notes from detected GitHub repos
   - Rate-limited and concurrent (respects GitHub API limits)
   - Falls back gracefully when token unavailable

**Output:** `src/data/apps.json` (unified data structure, ~96 packages total)

### Frontend (Astro)

**Entry Point:** `src/pages/index.astro`

- Imports JSON data from Go pipeline
- Renders responsive app cards (`src/components/AppCard.astro`)
- Implements filters (`src/components/FilterBar.astro`)
- Adds search and keyboard navigation
- Generates static HTML for GitHub Pages deployment

### Key Components

```
cmd/bluefin-releases/main.go    # Pipeline orchestration
internal/
  ├── models/models.go          # Unified data structures
  ├── bluefin/
  │   ├── flatpaks.go           # Bluefin Flatpak fetcher
  │   ├── homebrew.go           # Bluefin Homebrew fetcher
  │   └── releases.go           # Bluefin OS releases fetcher
  ├── flathub/flathub.go        # Flathub API client
  └── github/github.go          # GitHub API client
src/
  ├── pages/index.astro         # Main page
  ├── components/               # UI components
  └── data/apps.json            # Generated by pipeline
```

## Development Workflow

### Local Development

```bash
# Install dependencies
npm install
go mod download

# Build pipeline + site
npm run build

# Preview the site
npm run preview

# Development mode (requires pre-generated data)
npm run dev
```

### Running the Pipeline

```bash
# Without GitHub integration (uses Flathub/Homebrew metadata only)
go run cmd/bluefin-releases/main.go

# With GitHub integration (fetches actual release notes)
GITHUB_TOKEN=your_token_here go run cmd/bluefin-releases/main.go
```

### Testing Changes

1. **Backend changes** (Go code):
   ```bash
   go run cmd/bluefin-releases/main.go  # Test pipeline
   cat src/data/apps.json | jq '.apps | length'  # Verify output
   ```

2. **Frontend changes** (Astro):
   ```bash
   npm run build  # Build site
   npm run preview  # Preview locally
   ```

3. **Full integration test**:
   ```bash
   npm run build  # Runs pipeline + builds site
   npm run preview  # Verify in browser
   ```

## Common Tasks

### Adding a New Data Source

1. Create fetcher in `internal/bluefin/` (e.g., `newsource.go`)
2. Implement fetcher function returning `[]models.App`
3. Add fetcher call to `cmd/bluefin-releases/main.go`
4. Update merge logic in main.go (Step 4)
5. Test with `go run cmd/bluefin-releases/main.go`

### Modifying the UI

1. Edit components in `src/components/`
2. Update main page in `src/pages/index.astro`
3. Test with `npm run build && npm run preview`
4. Check responsive design (mobile/tablet/desktop)

### Debugging the Pipeline

1. **Check pipeline logs:**
   ```bash
   go run cmd/bluefin-releases/main.go 2>&1 | tee pipeline.log
   ```

2. **Inspect output JSON:**
   ```bash
   cat src/data/apps.json | jq '.metadata'  # Check metadata
   cat src/data/apps.json | jq '.apps[0]'   # Check first app
   cat src/data/apps.json | jq '.apps | map(.packageType) | group_by(.) | map({type: .[0], count: length})'  # Count by type
   ```

3. **Test specific fetchers:**
   ```bash
   # Add debug prints to fetcher functions
   # Run pipeline and check logs
   ```

4. **GitHub API issues:**
   ```bash
   # Check rate limits
   curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/rate_limit
   
   # Test specific repo
   curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/ublue-os/bluefin/releases
   ```

### Performance Tuning

Typical build times:
- **Flatpak fetch**: ~600-800ms (42 apps, parallel)
- **Homebrew fetch**: ~200-300ms (44 packages, parallel)
- **Bluefin OS fetch**: ~300ms (10 releases)
- **GitHub enrichment**: ~10-20s with token (rate-limited)
- **Astro build**: ~600ms
- **Total**: ~1-2s (no GitHub) or ~20-30s (with GitHub)

To optimize:
1. Reduce GitHub API calls (cache, batch, or filter repos)
2. Parallelize more operations (currently Flatpak/Homebrew/OS are sequential)
3. Use Go's `errgroup` for better concurrency control

## Deployment

The site deploys automatically via GitHub Actions (`.github/workflows/deploy.yml`):
- **Trigger**: Every 6 hours + on push to main + manual dispatch
- **Process**: Run Go pipeline → Build Astro site → Deploy to GitHub Pages
- **Environment**: `GITHUB_TOKEN` is auto-provided by GitHub Actions

## Landing the Plane (Session Completion)

**When ending a work session**, you MUST complete ALL steps below. Work is NOT complete until `git push` succeeds.

**MANDATORY WORKFLOW:**

1. **File issues for remaining work** - Create issues for anything that needs follow-up
2. **Run quality gates** (if code changed) - Tests, linters, builds
   ```bash
   # For Go changes
   go run cmd/bluefin-releases/main.go  # Verify pipeline works
   
   # For frontend changes
   npm run build  # Verify site builds
   ```
3. **Update issue status** - Close finished work, update in-progress items
4. **PUSH TO REMOTE** - This is MANDATORY:
   ```bash
   git pull --rebase
   bd sync
   git push
   git status  # MUST show "up to date with origin"
   ```
5. **Clean up** - Clear stashes, prune remote branches
6. **Verify** - All changes committed AND pushed
7. **Hand off** - Provide context for next session

**CRITICAL RULES:**
- Work is NOT complete until `git push` succeeds
- NEVER stop before pushing - that leaves work stranded locally
- NEVER say "ready to push when you are" - YOU must push
- If push fails, resolve and retry until it succeeds

## Debugging Tips

### Common Issues

1. **Pipeline fails to fetch Flatpak apps**
   - Check if Flathub API is accessible: `curl https://flathub.org/api/v2/appstream`
   - Verify app IDs in Brewfiles are valid
   - Check logs for rate limiting or network errors

2. **Homebrew packages missing**
   - Verify Homebrew formulae API: `curl https://formulae.brew.sh/api/formula/PACKAGE_NAME.json`
   - Check if package is Linux-compatible (some are macOS-only)
   - Ensure Brewfiles are properly formatted

3. **GitHub enrichment fails**
   - Check `GITHUB_TOKEN` is set and valid
   - Verify rate limits: `curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/rate_limit`
   - Pipeline will work without GitHub token (uses Flathub/Homebrew metadata only)

4. **Astro build fails**
   - Ensure `src/data/apps.json` exists and is valid JSON
   - Check Node.js version (requires 20+)
   - Run `npm install` to ensure dependencies are installed

5. **Site deployed but shows old data**
   - Check GitHub Actions logs for pipeline failures
   - Verify `apps.json` was updated in the build artifact
   - Clear browser cache and hard reload

